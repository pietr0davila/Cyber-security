
Server Message Block ou SMB é um protocolo nativo do windows e pode conter dados sensíveis como credenciais podem estar expostos em diretórios de compartilhamento de rede, algumas versões de SMB são vulneráveis a exploits de RCE (Remote code exec) já descobertos como o eternalBlue. Enumeração do serviço SMB é crucial. O nmap tem scripts de enumeração do serviço SMB como o smb-os-discovery.nse que interage com o SMB para retornar a versão do sistema operacional

```shell-session
anotherMan@htb[/htb]$ nmap --script smb-os-discovery.nse -p445 10.10.10.40

Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-27 00:59 GMT
Nmap scan report for doctors.htb (10.10.10.40)
Host is up (0.022s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: CEO-PC
|   NetBIOS computer name: CEO-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2020-12-27T00:59:46+00:00

Nmap done: 1 IP address (1 host up) scanned in 2.71 seconds
```

Como o código mostra, a porta padrão do SMB é a 445

## Compartilhamentos 

O protocolo SMB permite que administradores compartilhem arquivos para outros usuários, em alguns casos esses arquivos contém dados sensíveis como senhas. existem várias ferramentas para comunicação com o servidor smb, um exemplo é o smbclient

```shell-session
anotherMan@htb[/htb]$ smbclient -N -L \\\\10.129.42.253

	Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	users           Disk      
	IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available
```

A flag -N Especifica que não queremos entrar com uma senha, a flag -L pede uma lista dos diretórios de compartilhamento disponiveis

Tentando entrar no diretório users
```shell-session
anotherMan@htb[/htb]$ smbclient \\\\10.129.42.253\\users

Enter WORKGROUP\users's password: 
Try "help" to get a list of possible commands.

smb: \> ls
NT_STATUS_ACCESS_DENIED listing \*

smb: \> exit
```

O comando ls nos retorna acesso negado, então não podemos entrar nesse diretório sem um usuário e senha com permissão

Se usassemos uma credencial válida:
```shell-session
anotherMan@htb[/htb]$ smbclient -U bob \\\\10.129.42.253\\users

Enter WORKGROUP\bob's password: 
Try "help" to get a list of possible commands.

smb: \> ls
  .                                   D        0  Thu Feb 25 16:42:23 2021
  ..                                  D        0  Thu Feb 25 15:05:31 2021
  bob                                 D        0  Thu Feb 25 16:42:23 2021

		4062912 blocks of size 1024. 1332480 blocks available
		
smb: \> cd bob

smb: \bob\> ls
  .                                   D        0  Thu Feb 25 16:42:23 2021
  ..                                  D        0  Thu Feb 25 16:42:23 2021
  passwords.txt                       N      156  Thu Feb 25 16:42:23 2021

		4062912 blocks of size 1024. 1332480 blocks available
		
smb: \bob\> get passwords.txt 
getting file \bob\passwords.txt of size 156 as passwords.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)
```
